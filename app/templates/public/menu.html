{% extends 'base.html' %}

{% block title %}Menu - StreetBite{% endblock %}

{% block content %}
<div class="relative flex flex-col min-h-screen max-w-md mx-auto bg-white dark:bg-background-dark shadow-xl">
    {% if settings.shop_status != 'open' %}
    <!-- Closed Banner -->
    <div
        class="bg-rose-500 text-white text-[10px] font-black uppercase tracking-[0.2em] py-2 px-4 text-center sticky top-0 z-50">
        Shop Closed • Not Accepting Orders
    </div>
    {% endif %}
    <!-- Search Bar -->
    <div class="px-4 py-4 sticky top-16 z-20 bg-white/95 dark:bg-background-dark/95 backdrop-blur-md">
        <div class="relative group">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <span
                    class="material-symbols-outlined text-slate-400 group-focus-within:text-primary transition-colors">search</span>
            </div>
            <input type="text" id="menuSearch"
                class="block w-full pl-10 pr-4 py-3 bg-slate-100 dark:bg-slate-800 border-none rounded-xl focus:ring-2 focus:ring-primary/50 text-slate-900 dark:text-slate-100 placeholder-slate-500 transition-all outline-none"
                placeholder="Search for dishes...">
        </div>
    </div>

    <!-- Categories (Horizontal Scroll) -->
    <div
        class="flex gap-3 px-4 pb-4 overflow-x-auto no-scrollbar scroll-smooth bg-white/95 dark:bg-background-dark/95 backdrop-blur-md">
        <button onclick="filterCategory(null)"
            class="cat-btn whitespace-nowrap px-5 py-2 rounded-full bg-primary text-white font-semibold text-sm shadow-md shadow-primary/20"
            data-category="all">All Items</button>
        {% for cat in categories %}
        <button onclick="filterCategory('{{ cat.id }}')"
            class="cat-btn whitespace-nowrap px-5 py-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 font-medium text-sm hover:bg-primary/10 hover:text-primary transition-colors"
            data-category="{{ cat.id }}">{{ cat.name }}</button>
        {% endfor %}
    </div>

    <!-- Menu List -->
    <main class="flex-1 px-4 space-y-4 pb-28 min-h-[60vh]">
        {% if items %}
        {% for item in items %}
        <div class="menu-item bg-white dark:bg-slate-900 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800 flex justify-between gap-4 transition-all hover:shadow-md"
            data-category="{{ item.category_id }}" data-name="{{ item.name|lower }}">
            <div class="flex flex-col flex-1">
                <div class="flex items-center gap-1.5 mb-1">
                    {% if item.is_non_veg %}
                    <div class="size-4 border border-red-600 flex items-center justify-center p-0.5">
                        <div class="size-full rounded-full bg-red-600"></div>
                    </div>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Non-Veg</span>
                    {% else %}
                    <div class="size-4 border border-green-600 flex items-center justify-center p-0.5">
                        <div class="size-full rounded-full bg-green-600"></div>
                    </div>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Veg</span>
                    {% endif %}
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100">{{ item.name }}</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1 line-clamp-2 leading-relaxed">{{
                    item.description }}</p>
                <div class="mt-auto pt-3 flex items-center justify-between">
                    <span class="text-lg font-bold text-slate-900 dark:text-slate-100">₹{{ item.price }}</span>
                    <div class="flex gap-2">
                        {% if settings.shop_status == 'open' %}
                        <button onclick='addToCart({{ item.to_dict()|tojson }})'
                            class="flex items-center gap-1 px-4 py-1.5 bg-primary text-white hover:brightness-110 rounded-lg font-bold text-sm transition-all shadow-md shadow-primary/20">
                            ADD <span class="material-symbols-outlined text-sm">add_shopping_cart</span>
                        </button>
                        <button onclick='orderNow({{ item.to_dict()|tojson }})'
                            class="flex items-center size-9 bg-primary/10 text-primary hover:bg-primary hover:text-white rounded-lg transition-all justify-center">
                            <span class="material-symbols-outlined text-sm">send</span>
                        </button>
                        {% else %}
                        <button disabled
                            class="flex items-center gap-1 px-4 py-1.5 bg-slate-200 text-slate-400 rounded-lg font-bold text-sm cursor-not-allowed grayscale">
                            CLOSED
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% if item.image_path %}
            <div class="relative w-28 h-28 aspect-square shrink-0">
                <img src="{{ url_for('static', filename='uploads/' + item.image_path) }}"
                    class="w-full h-full rounded-xl object-cover bg-slate-200" alt="{{ item.name }}" loading="lazy">
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% else %}
        <div class="flex flex-col items-center justify-center py-20 text-center">
            <span class="material-symbols-outlined text-6xl text-slate-300 mb-4">restaurant_menu</span>
            <p class="text-slate-500">No items available at the moment.</p>
        </div>
        {% endif %}
    </main>
</div>

<script>
    function filterCategory(catId) {
        const items = document.querySelectorAll('.menu-item');
        const buttons = document.querySelectorAll('.cat-btn');

        // Update buttons
        buttons.forEach(btn => {
            if ((catId === null && btn.dataset.category === 'all') || btn.dataset.category == catId) {
                btn.classList.add('bg-primary', 'text-white', 'shadow-md', 'shadow-primary/20');
                btn.classList.remove('bg-slate-100', 'dark:bg-slate-800', 'text-slate-600', 'dark:text-slate-400');
            } else {
                btn.classList.remove('bg-primary', 'text-white', 'shadow-md', 'shadow-primary/20');
                btn.classList.add('bg-slate-100', 'dark:bg-slate-800', 'text-slate-600', 'dark:text-slate-400');
            }
        });

        // Filter items
        items.forEach(item => {
            if (catId === null || item.dataset.category == catId) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function orderNow(item) {
        addToCart(item);
        window.location.href = "{{ url_for('public.order_choice') }}";
    }

    // Search functionality
    document.getElementById('menuSearch').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.menu-item');

        items.forEach(item => {
            const name = item.dataset.name;
            if (name.includes(query)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}