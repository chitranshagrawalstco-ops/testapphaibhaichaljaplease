{% extends 'admin/base.html' %}

{% block admin_title %}Order Management{% endblock %}

{% block content %}
<div class="space-y-8">
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
        <div>
            <h1 class="text-3xl font-black tracking-tight">Order Management</h1>
            <p class="text-slate-500 mt-1">Manage and track customer bookings.</p>
        </div>
        <div class="relative w-full md:w-80">
            <span
                class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">search</span>
            <input type="text" id="orderSearch" oninput="filterOrders()" placeholder="Search by name or phone..."
                class="w-full pl-12 pr-4 py-3 rounded-xl border-none bg-white dark:bg-slate-800 shadow-sm focus:ring-2 focus:ring-primary transition-all">
        </div>
    </header>

    <!-- Filter Tabs -->
    <div class="flex gap-2 p-1 bg-slate-100 dark:bg-slate-800 rounded-xl w-fit">
        <button onclick="filterType('all')" id="tab-all"
            class="tab-btn px-6 py-2 rounded-lg text-sm font-bold bg-white dark:bg-slate-700 shadow-sm transition-all">All
            Orders</button>
        <button onclick="filterType('Pre-book')" id="tab-pre"
            class="tab-btn px-6 py-2 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all">Pre-Bookings</button>
        <button onclick="filterType('At Stall')" id="tab-stall"
            class="tab-btn px-6 py-2 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-all">Stall
            Bookings</button>
    </div>

    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-primary/5 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse table-fixed min-w-[1000px]">
                <thead>
                    <tr class="bg-slate-50 dark:bg-slate-900/50 border-b border-slate-100 dark:border-slate-800">
                        <th class="w-16 px-6 py-4 text-xs font-black uppercase tracking-widest text-slate-500">ID</th>
                        <th class="w-48 px-6 py-4 text-xs font-black uppercase tracking-widest text-slate-500">Customer
                        </th>
                        <th class="w-32 px-6 py-4 text-xs font-black uppercase tracking-widest text-slate-500">Type</th>
                        <th class="w-64 px-6 py-4 text-xs font-black uppercase tracking-widest text-slate-500">Items
                        </th>
                        <th class="w-24 px-6 py-4 text-xs font-black uppercase tracking-widest text-slate-500">Total
                        </th>
                        <th class="w-32 px-6 py-4 text-xs font-black uppercase tracking-widest text-slate-500">Status
                        </th>
                        <th class="w-40 px-6 py-4 text-xs font-black uppercase tracking-widest text-slate-500">Date/Time
                        </th>
                        <th class="w-32 px-6 py-4 text-xs font-black uppercase tracking-widest text-slate-500">Actions
                        </th>
                    </tr>
                </thead>
                <tbody id="ordersBody" class="divide-y divide-slate-100 dark:divide-slate-800">
                    {% for order in orders %}
                    <tr data-name="{{ (order.customer_name or '')|lower }}"
                        data-phone="{{ (order.customer_phone or '')|lower }}" data-type="{{ order.order_type }}"
                        class="order-row hover:bg-slate-50/50 dark:hover:bg-slate-900/20 transition-colors">
                        <td class="px-6 py-4 font-bold text-slate-400">#{{ order.id }}</td>
                        <td class="px-6 py-4">
                            <div class="font-bold">{{ order.customer_name or 'Anonymous' }}</div>
                            <div class="text-xs text-slate-500">{{ order.customer_phone or 'No phone' }}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded-md text-[10px] font-black uppercase tracking-wider 
                                {% if order.order_type == 'Pre-book' %}bg-emerald-100 text-emerald-600
                                {% else %}bg-amber-100 text-amber-600{% endif %}">
                                {{ order.order_type }}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-xs space-y-1">
                                {% for item in order.items %}
                                <div class="flex justify-between gap-4">
                                    <span>{{ item.quantity }}x {{ item.menu_item.name }}</span>
                                    <span class="text-slate-400 font-medium">₹{{ item.price_at_time }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </td>
                        <td class="px-6 py-4 font-black text-primary">₹{{ order.total_price }}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded-md text-[10px] font-black uppercase tracking-wider 
                                {% if order.status == 'Pending' %}bg-blue-100 text-blue-600
                                {% elif order.status == 'Completed' %}bg-emerald-100 text-emerald-600
                                {% else %}bg-rose-100 text-rose-600{% endif %}">
                                {{ order.status }}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-xs text-slate-500">{{ order.created_at.strftime('%d %b, %H:%M') }}</div>
                            {% if order.order_type == 'Pre-book' and order.estimated_arrival_time %}
                            <div class="mt-1 text-[10px] font-black text-rose-500 uppercase flex items-center gap-1">
                                <span class="material-symbols-outlined text-xs">schedule</span>
                                Arrival: {{ order.estimated_arrival_time }}
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <a href="{{ url_for('admin.update_order_status', id=order.id, status='Completed') }}"
                                    class="p-2 text-emerald-500 hover:bg-emerald-50 rounded-lg transition-colors {% if order.status == 'Completed' %}opacity-50 pointer-events-none{% endif %}"
                                    title="Mark Completed">
                                    <span class="material-symbols-outlined">check_circle</span>
                                </a>
                                <a href="{{ url_for('admin.update_order_status', id=order.id, status='Cancelled') }}"
                                    class="p-2 text-rose-500 hover:bg-rose-50 rounded-lg transition-colors {% if order.status == 'Cancelled' %}opacity-50 pointer-events-none{% endif %}"
                                    title="Cancel Order">
                                    <span class="material-symbols-outlined">cancel</span>
                                </a>
                                <a href="{{ url_for('admin.delete_order', id=order.id) }}"
                                    onclick="return confirm('Permanently delete this order?')"
                                    class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                    title="Delete Order">
                                    <span class="material-symbols-outlined">delete</span>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="px-6 py-20 text-center text-slate-400">
                            <span class="material-symbols-outlined text-5xl mb-4 block">inventory_2</span>
                            <p class="font-bold">No orders found.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let currentType = 'all';

    function filterOrders() {
        applyFilters();
    }

    function filterType(type) {
        currentType = type;

        // Update UI
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-white', 'dark:bg-slate-700', 'shadow-sm');
            btn.classList.add('text-slate-500', 'dark:text-slate-400');
        });

        const activeTabId = type === 'all' ? 'tab-all' : (type === 'Pre-book' ? 'tab-pre' : 'tab-stall');
        const activeTab = document.getElementById(activeTabId);
        activeTab.classList.add('bg-white', 'dark:bg-slate-700', 'shadow-sm');
        activeTab.classList.remove('text-slate-500', 'dark:text-slate-400');

        applyFilters();
    }

    function applyFilters() {
        const query = document.getElementById('orderSearch').value.toLowerCase();
        const rows = document.querySelectorAll('.order-row');

        rows.forEach(row => {
            const name = row.dataset.name;
            const phone = row.dataset.phone;
            const type = row.dataset.type;

            const matchesQuery = name.includes(query) || phone.includes(query);
            const matchesType = currentType === 'all' || type === currentType;

            if (matchesQuery && matchesType) {
                row.classList.remove('hidden');
            } else {
                row.classList.add('hidden');
            }
        });
    }
</script>
{% endblock %}